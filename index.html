<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>ECG Live Monitor</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
  html, body {
    margin: 0;
    padding: 0;
    background: #000;
    color: #fff;
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display";
    overflow: hidden;
  }

  #topbar {
    position: absolute;
    top: 20px;
    left: 24px;
    right: 24px;
    display: flex;
    justify-content: space-between;
    z-index: 10;
  }

  .metric label {
    font-size: 13px;
    opacity: 0.6;
  }

  .metric value {
    font-size: 28px;
    font-weight: 500;
  }

  #status {
    text-align: right;
  }

  #status span {
    font-size: 22px;
    font-weight: 600;
    color: #00ff9c;
  }

  canvas {
    position: absolute;
    top: 80px;
    left: 0;
    right: 0;
    bottom: 0;
  }
</style>
</head>

<body>

<div id="topbar">
  <div class="metric">
    <label>Heart Rate</label>
    <div class="value" id="hr">—</div>
  </div>

  <div id="status">
    <label>Status</label><br/>
    <span>Live</span>
  </div>
</div>

<canvas id="ecg"></canvas>

<script>
/* ===============================
   CANVAS SETUP
================================ */
const canvas = document.getElementById("ecg");
const ctx = canvas.getContext("2d");

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight - 80;
  drawGrid();
}
window.addEventListener("resize", resize);
resize();

/* ===============================
   ECG DISPLAY PARAMETERS
================================ */
const ECG_GAIN = 0.25;           // main vertical gain
const PIXELS_PER_UNIT = 0.08;    // converts ADC → pixels
const BASELINE_ALPHA = 0.01;     // baseline wander removal

let baseline = 0;
let x = 0;

/* ===============================
   DRAW GRID
================================ */
function drawGrid() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.strokeStyle = "rgba(255,255,255,0.06)";
  ctx.lineWidth = 1;

  const grid = 40;
  for (let i = 0; i < canvas.width; i += grid) {
    ctx.beginPath();
    ctx.moveTo(i, 0);
    ctx.lineTo(i, canvas.height);
    ctx.stroke();
  }
  for (let i = 0; i < canvas.height; i += grid) {
    ctx.beginPath();
    ctx.moveTo(0, i);
    ctx.lineTo(canvas.width, i);
    ctx.stroke();
  }
}

/* ===============================
   DRAW ECG
================================ */
function drawECG(sample) {
  const midY = canvas.height / 2;

  const y = midY - (sample * ECG_GAIN * PIXELS_PER_UNIT);

  ctx.lineWidth = 2;
  ctx.strokeStyle = "#00ff9c";

  ctx.beginPath();
  ctx.moveTo(x, y);
  x += 1;
  ctx.lineTo(x, y);
  ctx.stroke();

  if (x >= canvas.width) {
    x = 0;
    drawGrid();
  }
}

/* ===============================
   WEBSOCKET CONNECT
================================ */
const WS_URL = "wss://ecg-cloud-production.up.railway.app";
const socket = new WebSocket(WS_URL);

socket.onopen = () => {
  console.log("ECG stream connected");
};

socket.onmessage = (event) => {
  const data = JSON.parse(event.data);
  if (!data.ecg) return;

  const raw = data.ecg;

  // --- baseline removal (MATLAB-like)
  baseline += BASELINE_ALPHA * (raw - baseline);

  const centered = raw - baseline;
  drawECG(centered);
};

socket.onerror = (err) => {
  console.error("WebSocket error", err);
};
</script>

</body>
</html>
